
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://github.com/msykd/smart-contract-best-practices/known_attacks/">
      
      
        <meta name="author" content="msykd">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.languages" content="">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      
        <link rel="shortcut icon" href="../images/favicon.ico">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.12.1">
    
    
      
        <title>既知の攻撃方法 - Ethereum Smart Contract Best Practices(日本語訳)</title>
      
    
    
      <script src="../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-04ea671600.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://github.com/msykd/smart-contract-best-practices/" title="Ethereum Smart Contract Best Practices(日本語訳)" class="md-header-nav__button md-logo">
          
            <i class="md-icon md-icon--home"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            既知の攻撃方法
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/msykd/smart-contract-best-practices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </span>
    Ethereum Smart Contract Best Practices(日本語訳)
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/msykd/smart-contract-best-practices/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="ホーム" class="md-nav__link">
      ホーム
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../general_philosophy/" title="基本的な知識" class="md-nav__link">
      基本的な知識
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../recommendations/" title="推奨する実装方法" class="md-nav__link">
      推奨する実装方法
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        既知の攻撃方法
      </label>
    
    <a href="./" title="既知の攻撃方法" class="md-nav__link md-nav__link--active">
      既知の攻撃方法
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#race-conditions42" title="Race Conditions*" class="md-nav__link">
    Race Conditions*
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reentrancy" title="Reentrancy" class="md-nav__link">
    Reentrancy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-function-race-conditions" title="Cross-function Race Conditions" class="md-nav__link">
    Cross-function Race Conditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfalls-in-race-condition-solutions" title="Pitfalls in Race Condition Solutions" class="md-nav__link">
    Pitfalls in Race Condition Solutions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transaction-ordering-dependence-tod-front-running" title="Transaction-Ordering Dependence (TOD) / Front Running" class="md-nav__link">
    Transaction-Ordering Dependence (TOD) / Front Running
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamp-dependence" title="Timestamp Dependence" class="md-nav__link">
    Timestamp Dependence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integer-overflow-and-underflow" title="Integer Overflow and Underflow" class="md-nav__link">
    Integer Overflow and Underflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-unexpected-revert" title="DoS with (Unexpected) revert" class="md-nav__link">
    DoS with (Unexpected) revert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-block-gas-limit" title="DoS with Block Gas Limit" class="md-nav__link">
    DoS with Block Gas Limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forcibly-sending-ether-to-a-contract" title="Forcibly Sending Ether to a Contract" class="md-nav__link">
    Forcibly Sending Ether to a Contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deprecatedhistorical-attacks" title="Deprecated/historical attacks" class="md-nav__link">
    Deprecated/historical attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-depth-attack-deprecated" title="Call Depth Attack (deprecated)" class="md-nav__link">
    Call Depth Attack (deprecated)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../software_engineering/" title="リスクの備え方" class="md-nav__link">
      リスクの備え方
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../documentation_procedures/" title="ドキュメント化の手法" class="md-nav__link">
      ドキュメント化の手法
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security_tools/" title="便利なツール" class="md-nav__link">
      便利なツール
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../security_notifications/" title="セキュリティに関する情報" class="md-nav__link">
      セキュリティに関する情報
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../future_improvements/" title="Future improvements" class="md-nav__link">
      Future improvements
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../bibliography/" title="Smart Contract Security Bibliography" class="md-nav__link">
      Smart Contract Security Bibliography
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/reviewers/" title="Reviewers" class="md-nav__link">
      Reviewers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../about/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../about/contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#race-conditions42" title="Race Conditions*" class="md-nav__link">
    Race Conditions*
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reentrancy" title="Reentrancy" class="md-nav__link">
    Reentrancy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cross-function-race-conditions" title="Cross-function Race Conditions" class="md-nav__link">
    Cross-function Race Conditions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pitfalls-in-race-condition-solutions" title="Pitfalls in Race Condition Solutions" class="md-nav__link">
    Pitfalls in Race Condition Solutions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transaction-ordering-dependence-tod-front-running" title="Transaction-Ordering Dependence (TOD) / Front Running" class="md-nav__link">
    Transaction-Ordering Dependence (TOD) / Front Running
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timestamp-dependence" title="Timestamp Dependence" class="md-nav__link">
    Timestamp Dependence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integer-overflow-and-underflow" title="Integer Overflow and Underflow" class="md-nav__link">
    Integer Overflow and Underflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-unexpected-revert" title="DoS with (Unexpected) revert" class="md-nav__link">
    DoS with (Unexpected) revert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dos-with-block-gas-limit" title="DoS with Block Gas Limit" class="md-nav__link">
    DoS with Block Gas Limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#forcibly-sending-ether-to-a-contract" title="Forcibly Sending Ether to a Contract" class="md-nav__link">
    Forcibly Sending Ether to a Contract
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deprecatedhistorical-attacks" title="Deprecated/historical attacks" class="md-nav__link">
    Deprecated/historical attacks
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-depth-attack-deprecated" title="Call Depth Attack (deprecated)" class="md-nav__link">
    Call Depth Attack (deprecated)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/msykd/smart-contract-best-practices/edit/master/docs/known_attacks.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>既知の攻撃方法</h1>
                
                <p>以下は既知の攻撃方法の一覧です。スマートコントラクトを書く上でこれらの対策を行ってください。</p>
<h2 id="race-conditions42">Race Conditions<sup><a href='#footnote-race-condition-terminology'>*</a></sup><a class="headerlink" href="#race-conditions42" title="Permanent link">&para;</a></h2>
<p>外部コントラクトを呼び出す際の主要な危険の1つは、コントロールフローを引き継ぎ、呼び出し関数が期待していなかったデータを変更できることです。
このクラスのバグはいろいろな形を取ることができ、DAOの崩壊につながった主要なバグの両方がこの種のバグでした。</p>
<h3 id="reentrancy">Reentrancy<a class="headerlink" href="#reentrancy" title="Permanent link">&para;</a></h3>
<p>このバグの最初のバージョンには、関数の最初の呼び出しが終了する前に、繰り返し呼び出される可能性のある関数が含まれていました。
これにより、関数のさまざまな呼び出しが破壊的なやり方で相互作用する可能性があります。</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)());</span> <span class="c1">// At this point, the caller&#39;s code is executed, and can call withdrawBalance again</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>機能の最後までユーザーの残高が0に設定されていないため、2回目以降の呼び出しは引き続き成功し、何度も何度も残高を回収します。
非常によく似たバグが、The DAOの脆弱性の1つでした。</p>
<p>この問題を避ける最も良い方法は、<a href="https://github.com/ConsenSys/smart-contract-best-practices#send-vs-call-value"><code>call.value()()</code>の代わりに<code>send()</code> を使うことです</a>。
これにより外部コードの実行を防ぎます。</p>
<p>ただし、外部呼び出しを削除できない場合、この攻撃を防ぐ最も簡単な方法は、必要な内部作業をすべて完了するまで外部関数を呼び出さないようにすることです。</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)());</span> <span class="c1">// The user&#39;s balance is already 0, so future invocations won&#39;t withdraw anything</span>
<span class="p">}</span>
</pre></div>

<p><code>withdrawBalance()</code>と呼ばれる別の関数があった場合、それは潜在的に同じ攻撃の対象となるため、
信頼できないコントラクトを呼び出す関数を信頼できないものとして扱わなければなりません。 潜在的な解決策の詳細については、以下を参照してください。</p>
<h3 id="cross-function-race-conditions">Cross-function Race Conditions<a class="headerlink" href="#cross-function-race-conditions" title="Permanent link">&para;</a></h3>
<p>攻撃者は同じ状態を共有する2つの異なる機能を使用して同様の攻撃を行うこともできます。</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">userBalances</span><span class="p">[</span><span class="n">to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">amount</span><span class="p">;</span>
       <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">withdrawBalance</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">];</span>
    <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)());</span> <span class="c1">// At this point, the caller&#39;s code is executed, and can call transfer()</span>
    <span class="n">userBalances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>この場合、攻撃者は <code>withdrawBalance</code>で外部呼び出しでコードが実行されるときに<code>transfer()</code>を呼び出します。
残高はまだ0に設定されていないので、すでに引き出しを受けていてもトークンを転送することができます。この脆弱性は、The DAOへの攻撃にも使用されていました。</p>
<p>同じ解決策が、同じ警告で動作します。
この例では、両方の関数が同じ契約の一部であったことにも注意してください。
ただし、同じコントラクトが複数のコントラクトを共有している場合、複数のコントラクトで同じバグが発生する可能性があります。</p>
<h3 id="pitfalls-in-race-condition-solutions">Pitfalls in Race Condition Solutions<a class="headerlink" href="#pitfalls-in-race-condition-solutions" title="Permanent link">&para;</a></h3>
<p>競合状態は複数の機能、さらには複数のコントラクトにわたって発生する可能性があるため、再入を防止するためのソリューションは十分ではありません。</p>
<p>代わりに、最初にすべての内部作業を終了してから、外部関数を呼び出すことを推奨しました。
このルールは、慎重に従うと競争条件を避けることができます。
しかし、外部関数をあまりにも早く呼び出さないようにするだけでなく、外部関数を呼び出す関数を呼び出さないようにする必要があります。
たとえば、以下は安全ではありません。</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="kr">private</span> <span class="n">claimedBonus</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">rewardsForA</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="n">recipient</span><span class="p">];</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">require</span><span class="p">(</span><span class="n">recipient</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)());</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">getFirstWithdrawalBonus</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]);</span> <span class="c1">// Each recipient should only be able to claim the bonus once</span>

    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">withdraw</span><span class="p">(</span><span class="n">recipient</span><span class="p">);</span> <span class="c1">// At this point, the caller will be able to execute getFirstWithdrawalBonus again.</span>
    <span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p><code>getFirstWithdrawalBonus()</code>は外部コントラクトを直接呼び出さなくても、 <code>withdraw()</code>の呼び出しは競合状態に脆弱にするのに十分です。
したがって、 <code>withdraw()</code>も信頼できないように扱う必要があります。</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">userBalances</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">bool</span><span class="p">)</span> <span class="kr">private</span> <span class="n">claimedBonus</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">rewardsForA</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">untrustedWithdraw</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="n">amountToWithdraw</span> <span class="o">=</span> <span class="n">userBalances</span><span class="p">[</span><span class="n">recipient</span><span class="p">];</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">require</span><span class="p">(</span><span class="n">recipient</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="n">value</span><span class="p">(</span><span class="n">amountToWithdraw</span><span class="p">)());</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">untrustedGetFirstWithdrawalBonus</span><span class="p">(</span><span class="kt">address</span> <span class="n">recipient</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]);</span> <span class="c1">// Each recipient should only be able to claim the bonus once</span>

    <span class="n">claimedBonus</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">rewardsForA</span><span class="p">[</span><span class="n">recipient</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="n">untrustedWithdraw</span><span class="p">(</span><span class="n">recipient</span><span class="p">);</span> <span class="c1">// claimedBonus has been set to true, so reentry is impossible</span>
<span class="p">}</span>
</pre></div>

<p>再入力が不可能であることに加えて、<a href="https://github.com/ConsenSys/smart-contract-best-practices#mark-untrusted-contracts">信頼できない関数がマークされてます。</a>
この同じパターンは、すべてのレベルで繰り返されます。
<code>untrustedGetFirstWithdrawalBonus()</code>は外部コントラクトを呼び出す <code>untrustedWithdraw()</code>を呼び出すので、
<code>untrustedGetFirstWithdrawalBonus()</code>も安全でないものとして扱わなければなりません。</p>
<p>しばしば提案される別の解決策は、<a href="https://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a>です。
これにより、ロックの所有者だけが変更できるように、状態を「ロック」することができます。 簡単な例は次のようになります。</p>
<div class="highlight"><pre><span></span><span class="c1">// Note: This is a rudimentary example, and mutexes are particularly useful where there is substantial logic and/or shared state</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">private</span> <span class="n">balances</span><span class="p">;</span>
<span class="kt">bool</span> <span class="kr">private</span> <span class="n">lockBalances</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">deposit</span><span class="p">()</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">lockBalances</span><span class="p">);</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="kr">payable</span> <span class="kr">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">require</span><span class="p">(</span><span class="o">!</span><span class="n">lockBalances</span> <span class="o">&amp;&amp;</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">(</span><span class="n">amount</span><span class="p">)())</span> <span class="p">{</span> <span class="c1">// Normally insecure, but the mutex saves it</span>
      <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">amount</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">lockBalances</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>ユーザーが最初の呼び出しが終了する前に <code>withdraw()</code>をもう一度呼び出そうとすると、ロックによって何も効果がありません。
これは効果的なパターンかもしれませんが、協力が必要な複数のコントラクトがある場合は面倒です。
以下は安全ではありません。</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">contract</span> <span class="n">StateHolder</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">private</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">address</span> <span class="kr">private</span> <span class="n">lockHolder</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">getLock</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="n">lockHolder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">lockHolder</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">releaseLock</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">lockHolder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">set</span><span class="p">(</span><span class="kt">uint</span> <span class="n">newState</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span> <span class="o">==</span> <span class="n">lockHolder</span><span class="p">);</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">newState</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>攻撃者は <code>getLock()</code>を呼び出し、 <code>releaseLock()</code>を決して呼び出すことはできません。
彼らがこれをすると、契約は永遠にロックされ、それ以上の変更はできません。
競合状態を防ぐためにmutexを使用する場合は、ロックを要求して解放する方法がないことを慎重に確認する必要があります。
(デッドロックやライブロックのようなmutexを使ってプログラミングするときには、潜在的な危険性がありますので、mutexに書かれている大量の文献を参考にしてください。</p>
<p><a name='footnote-race-condition-terminology'></a></p>
<div style='font-size: 80%; display: inline;'>* Some may object to the use of the term <i>race condition</i> since Ethereum does not currently have true parallelism. However, there is still the fundamental feature of logically distinct processes contending for resources, and the same sorts of pitfalls and potential solutions apply.</div>

<h2 id="transaction-ordering-dependence-tod-front-running">Transaction-Ordering Dependence (TOD) / Front Running<a class="headerlink" href="#transaction-ordering-dependence-tod-front-running" title="Permanent link">&para;</a></h2>
<p>上記は攻撃者が単一のトランザクションで悪質なコードを実行することを含む競合状態の例です。
以下は、ブロックチェーンに固有の競合状態の異なるタイプです。つまり、トランザクションの順序(ブロック内)が操作の対象になりやすいという事実です。</p>
<p>しばらくの間、トランザクションはmempool内にあるので、ブロック内に入る前に、どのアクションが起こるかを知ることができます。
これは、分権化された市場のように、いくつかのトークンを購入するトランザクションを見ることができ、
他のトランザクションが含まれる前に実装された市場秩序のために厄介なことがあります。
特定のコントラクトそのものになるため、これを防ぐことは困難です。
たとえば、市場では、バッチオークションを実装する方がよいでしょう(これはまた、高頻度取引の懸念から保護します)。
事前コミットスキームを使用する別の方法もあります。後で詳細を記します。</p>
<h2 id="timestamp-dependence">Timestamp Dependence<a class="headerlink" href="#timestamp-dependence" title="Permanent link">&para;</a></h2>
<p>ブロックのタイムスタンプは、マイナーによって操作され、タイムスタンプの直接的および間接的な使用をすべて考慮する必要があることに注意してください。
*ブロック数*と*平均ブロック時間*は時間の見積もりに使用できますが、ブロック時間が変更される可能性がある(キャスパーで予想される変更など)将来の証拠ではありません。</p>
<div class="highlight"><pre><span></span><span class="kt">uint</span> <span class="n">someVariable</span> <span class="o">=</span> <span class="nb">now</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">now</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// the now can be manipulated by the miner</span>

<span class="p">}</span>

<span class="k">if</span> <span class="p">((</span><span class="n">someVariable</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// someVariable can be manipulated by the miner</span>

<span class="p">}</span>
</pre></div>

<h2 id="integer-overflow-and-underflow">Integer Overflow and Underflow<a class="headerlink" href="#integer-overflow-and-underflow" title="Permanent link">&para;</a></h2>
<p>簡単なトークン転送を想定します。</p>
<div class="highlight"><pre><span></span><span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint256</span><span class="p">)</span> <span class="kr">public</span> <span class="n">balanceOf</span><span class="p">;</span>

<span class="c1">// INSECURE</span>
<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Check if sender has balance */</span>
    <span class="n">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_value</span><span class="p">);</span>
    <span class="cm">/* Add and subtract new balances */</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// SECURE</span>
<span class="kd">function</span> <span class="n">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Check if sender has balance and for overflows */</span>
    <span class="n">require</span><span class="p">(</span><span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_value</span> <span class="o">&amp;&amp;</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+</span> <span class="n">_value</span> <span class="o">&gt;=</span> <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]);</span>

    <span class="cm">/* Add and subtract new balances */</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>天びんが最大のuint値(2 ^ 256)に達すると、ゼロに丸く戻ります。これにより、その状態がチェックされます。
これは、実装に応じて適切かどうかは関係ありません。
uint値にこのような大きな値に近づく機会があるかどうかについて考えてみましょう。
uint変数がどのように状態を変え、そのような変更を行う権限を持っているかについて考えます。
uint値を更新する関数を呼び出すことができるユーザーがいる場合、攻撃を受けやすくなります。
管理者だけが変数の状態を変更するためのアクセス権を持っている場合、あなたは安全かもしれません。
ユーザーが一度に1だけインクリメントできる場合は、この制限に達する実現可能な方法がないため、おそらく安全です。</p>
<p>アンダーフローについても同様です。 uintが0より小さくなると、アンダーフローが発生し、最大値に設定されます。
uint8、uint16、uint24 ...などの小さなデータ型には注意してください。さらに簡単に最大値に達することができます。</p>
<p><a href="https://github.com/ethereum/solidity/issues/796#issuecomment-253578925">20 cases for overflow and underflow</a>.</p>
<p><a name="dos-with-unexpected-revert"></a></p>
<h2 id="dos-with-unexpected-revert">DoS with (Unexpected) revert<a class="headerlink" href="#dos-with-unexpected-revert" title="Permanent link">&para;</a></h2>
<p>簡単なオークションのコントラクトを想定します。</p>
<div class="highlight"><pre><span></span><span class="c1">// INSECURE</span>
<span class="kd">contract</span> <span class="n">Auction</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">currentLeader</span><span class="p">;</span>
    <span class="kt">uint</span> <span class="n">highestBid</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">bid</span><span class="p">()</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">highestBid</span><span class="p">);</span>

        <span class="n">require</span><span class="p">(</span><span class="n">currentLeader</span><span class="p">.</span><span class="nb">send</span><span class="p">(</span><span class="n">highestBid</span><span class="p">));</span> <span class="c1">// Refund the old leader, if it fails then revert</span>

        <span class="n">currentLeader</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">;</span>
        <span class="n">highestBid</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>古いリーダーを払い戻そうとすると、払い戻しが失敗した場合に元のリーダーに戻ります。
これは、悪意のある入札者が、そのアドレスへの払い戻しが常に失敗することを確実にしながら、リーダーになれることを意味します。
このようにして、他の誰かが <code>bid()</code>関数を呼び出すのを防ぐことができ、リーダーを永遠にとどめることができます。
前に説明したように、
<a href="https://github.com/ConsenSys/smart-contract-best-practices/#favor-pull-over-push-payments">pull payment system</a>
を代わりに設定することをお勧めします。</p>
<p>もう1つの例は、契約によってユーザー(例えば、クラウドファンディングコントラクトの支援者)に支払うために配列を反復する場合である。
それぞれの支払いが成功することを確認することが一般的です。
そうでない場合は、元に戻す必要があります。 問題は、1つの呼び出しが失敗した場合、支払いシステム全体を元に戻すことです。
つまり、ループは完了しません。 1つのアドレスで強制的にエラーが発生するため、誰も支払いを受けません。</p>
<div class="highlight"><pre><span></span><span class="kt">address</span><span class="p">[]</span> <span class="kr">private</span> <span class="n">refundAddresses</span><span class="p">;</span>
<span class="kd">mapping</span> <span class="p">(</span><span class="kt">address</span> <span class="o">=&gt;</span> <span class="kt">uint</span><span class="p">)</span> <span class="kr">public</span> <span class="n">refunds</span><span class="p">;</span>

<span class="c1">// bad</span>
<span class="kd">function</span> <span class="n">refundAll</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">uint</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">refundAddresses</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// arbitrary length iteration based on how many addresses participated</span>
        <span class="n">require</span><span class="p">(</span><span class="n">refundAddresses</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="nb">send</span><span class="p">(</span><span class="n">refunds</span><span class="p">[</span><span class="n">refundAddresses</span><span class="p">[</span><span class="n">x</span><span class="p">]]))</span> <span class="c1">// doubly bad, now a single failure on send will hold up all funds</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>ここでも推奨の解決策は <a href="#favor-pull-over-push-payments">favor pull over push payments</a>です。</p>
<h2 id="dos-with-block-gas-limit">DoS with Block Gas Limit<a class="headerlink" href="#dos-with-block-gas-limit" title="Permanent link">&para;</a></h2>
<p>あなたは前の例に別の問題があることに気づいたかもしれません。
一度に全員に払い戻すことで、ブロックガス制限にぶつかる危険性があります。
各Ethereumブロックは、ある最大量の計算を処理することができます。それを越えようとすると、あなたのトランザクションは失敗します。</p>
<p>これは、意図的な攻撃がなくても問題につながる可能性があります。
しかし、攻撃者が必要なガスの量を操作できるならば、特に悪いことです。
前の例の場合、攻撃者はアドレスの束を追加することができ、それぞれは非常に小さな払い戻しを必要とします。
したがって、各攻撃者のアドレスを払い戻すためのガスコストは、ガス制限を超えてしまい、払い戻し取引がまったく起こらないようになる可能性があります。</p>
<p>これが<a href="#favor-pull-over-push-payments">favor pull over push payments</a>のもうひとつの理由です。</p>
<p>未知のサイズの配列を絶対にループする必要がある場合は、複数のブロックを取る可能性があるため、複数のトランザクションが必要になる可能性があります。
次の例のように、あなたがどれぐらい離れているかを追跡し、その時点から再開できるようにする必要があります。</p>
<div class="highlight"><pre><span></span><span class="kd">struct</span> <span class="n">Payee</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Payee</span><span class="p">[]</span> <span class="n">payees</span><span class="p">;</span>
<span class="kt">uint256</span> <span class="n">nextPayeeIndex</span><span class="p">;</span>

<span class="kd">function</span> <span class="n">payOut</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nextPayeeIndex</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">payees</span><span class="p">.</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="nb">msg</span><span class="p">.</span><span class="n">gas</span> <span class="o">&gt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">payees</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="nb">send</span><span class="p">(</span><span class="n">payees</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nextPayeeIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p><code>payOut()</code>関数の次の反復を待っている間に他のトランザクションが処理されても何の悪いことも起こらないようにする必要があります。
このパターンは、絶対に必要な場合にのみ使用してください。</p>
<h2 id="forcibly-sending-ether-to-a-contract">Forcibly Sending Ether to a Contract<a class="headerlink" href="#forcibly-sending-ether-to-a-contract" title="Permanent link">&para;</a></h2>
<p>Etherをコントラクトに強制的に送信することは、フォールバック機能をトリガーすることなく可能です。
これは、フォールバック機能に重要なロジックを配置したり、契約の残高に基づいて計算を行う際に重要な考慮事項です。
次の例を考えてみましょう。</p>
<div class="highlight"><pre><span></span><span class="kd">contract</span> <span class="n">Vulnerable</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="p">()</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="n">revert</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="n">somethingBad</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">require</span><span class="p">(</span><span class="nb">this</span><span class="p">.</span><span class="nb">balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="c1">// Do something bad</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>このロジックはコントラクトへの支払いを拒否し、何か悪いことが起こらないようにしているようです。
しかしながら、Etherを強制的にコントラクトに送り、それゆえ、そのバランスをゼロより大きくするためのいくつかの方法が存在します。</p>
<p><code>selfdestruct</code>メソッドは、ユーザーが余分なEtherを送信する受益者を指定することを可能にします。(
<a href="https://solidity.readthedocs.io/en/develop/security-considerations.html#sending-and-receiving-ether">does not trigger a contract's fallback function</a>)</p>
<p>展開する前に、コントラクトのアドレスを<a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/ricmoo">precompute</a>に送信し、
そのアドレスにEtherを送信することもできます。</p>
<p>コントラクトエンジニアは、Etherを強制的に送ることができることに注意し、それに応じてロジックを設計する必要があります。
一般的に、資金調達源をコントラクトに制限することはできないと仮定します。</p>
<h2 id="deprecatedhistorical-attacks">Deprecated/historical attacks<a class="headerlink" href="#deprecatedhistorical-attacks" title="Permanent link">&para;</a></h2>
<p>これは、プロトコルの変更や強固性の向上により、もはや不可能な攻撃です。 後世のためにここに記録されています。</p>
<h3 id="call-depth-attack-deprecated">Call Depth Attack (deprecated)<a class="headerlink" href="#call-depth-attack-deprecated" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/ethereum/EIPs/issues/150">EIP 150</a>ハードフォークの時点では、Call Depth攻撃はもはや意味がありません。
<sup><a href='http://ethereum.stackexchange.com/questions/9398/how-does-eip-150-change-the-call-depth-attack'>*</a></sup>
(すべてのガスは1024の深さ制限に達する前に十分消費されるでしょう)</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../recommendations/" title="推奨する実装方法" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                推奨する実装方法
              </span>
            </div>
          </a>
        
        
          <a href="../software_engineering/" title="リスクの備え方" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                リスクの備え方
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-946997f430.js"></script>
      
      
      <script>app.initialize({version:"0.16.3",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>